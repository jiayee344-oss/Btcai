<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BTC/USDT æ™ºèƒ½äº¤æ˜“ç³»ç»Ÿ - ä¼˜åŒ–ç‰ˆ</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .signal-buy { background: linear-gradient(135deg, rgba(16, 185, 129, 0.15), rgba(6, 78, 59, 0.1)); border-left: 4px solid #10b981; }
        .signal-sell { background: linear-gradient(135deg, rgba(239, 68, 68, 0.15), rgba(127, 29, 29, 0.1)); border-left: 4px solid #ef4444; }
        .signal-hold { background: linear-gradient(135deg, rgba(156, 163, 175, 0.15), rgba(55, 65, 81, 0.1)); border-left: 4px solid #9ca3af; }
        .signal-closed { background: linear-gradient(135deg, rgba(245, 158, 11, 0.15), rgba(146, 64, 14, 0.1)); border-left: 4px solid #f59e0b; }
        .tp-hit { animation: pulse-green 1.5s infinite; background: rgba(16, 185, 129, 0.25) !important; }
        .sl-hit { animation: pulse-red 1.5s infinite; background: rgba(239, 68, 68, 0.25) !important; }
        @keyframes pulse-green { 0% { transform: scale(1); } 50% { transform: scale(1.02); } 100% { transform: scale(1); } }
        @keyframes pulse-red { 0% { transform: scale(1); } 50% { transform: scale(1.02); } 100% { transform: scale(1); } }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #1f2937; border-radius: 4px; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-900 text-gray-100">
    <div class="container mx-auto p-4 max-w-6xl">
        <!-- å¤´éƒ¨ -->
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold text-yellow-500 mb-2">
                <i class="fas fa-brain mr-2"></i>BTC/USDT æ™ºèƒ½äº¤æ˜“ç³»ç»Ÿ - ä¼˜åŒ–ç‰ˆ
            </h1>
            <p class="text-gray-400">åŠ¨æ€TP/SL | æ™ºèƒ½é£æ§ | çŠ¶æ€è¿½è¸ª | Telegramé€šçŸ¥</p>
        </div>

        <!-- æ§åˆ¶é¢æ¿ -->
        <div class="bg-gray-800 rounded-xl p-4 mb-6 shadow-lg border border-gray-700">
            <div class="flex flex-wrap items-center justify-between gap-4">
                <div class="flex items-center space-x-4">
                    <button onclick="initSystem()" class="px-4 py-2 bg-green-600 hover:bg-green-700 rounded-lg font-semibold">
                        <i class="fas fa-play mr-2"></i>å¯åŠ¨ç³»ç»Ÿ
                    </button>
                    <button onclick="manualGenerateSignal()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg font-semibold">
                        <i class="fas fa-bolt mr-2"></i>ç”Ÿæˆä¿¡å·
                    </button>
                    <button onclick="closeCurrentTrade()" class="px-4 py-2 bg-red-600 hover:bg-red-700 rounded-lg font-semibold">
                        <i class="fas fa-times mr-2"></i>å…³é—­äº¤æ˜“
                    </button>
                    <button onclick="openConfigPanel()" class="px-4 py-2 bg-purple-600 hover:bg-purple-700 rounded-lg font-semibold">
                        <i class="fas fa-cog mr-2"></i>ç³»ç»Ÿé…ç½®
                    </button>
                </div>
                
                <div class="flex items-center space-x-4">
                    <div class="px-3 py-1 bg-gray-700 rounded-lg">
                        <span class="text-gray-400 mr-2">ç”¨æˆ·ID:</span>
                        <span id="userIdDisplay" class="text-yellow-400">æœªè®¾ç½®</span>
                    </div>
                    <button onclick="setUserId()" class="px-4 py-2 bg-purple-600 hover:bg-purple-700 rounded-lg font-semibold">
                        <i class="fas fa-user mr-2"></i>è®¾ç½®ç”¨æˆ·
                    </button>
                    <button onclick="testTelegram()" class="px-4 py-2 bg-cyan-600 hover:bg-cyan-700 rounded-lg font-semibold">
                        <i class="fab fa-telegram mr-2"></i>æµ‹è¯•é€šçŸ¥
                    </button>
                </div>
            </div>
        </div>

        <!-- é…ç½®é¢æ¿ (é»˜è®¤éšè—) -->
        <div id="configPanel" class="hidden bg-gray-800 rounded-xl p-6 mb-6 shadow-lg border border-gray-700">
            <h2 class="text-xl font-semibold mb-4 text-yellow-400">
                <i class="fas fa-sliders-h mr-2"></i>ç³»ç»Ÿé…ç½®
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="space-y-4">
                    <h3 class="text-lg font-semibold text-gray-300">Telegram é…ç½®</h3>
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">Bot Token</label>
                        <input type="password" id="botToken" 
                               class="w-full px-3 py-2 bg-gray-900 border border-gray-700 rounded-lg text-gray-100"
                               placeholder="è¾“å…¥æ‚¨çš„Bot Token">
                        <p class="text-xs text-gray-500 mt-1">ä» @BotFather è·å–çš„Bot Token</p>
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">é»˜è®¤Chat ID</label>
                        <input type="text" id="defaultChatId" 
                               class="w-full px-3 py-2 bg-gray-900 border border-gray-700 rounded-lg text-gray-100"
                               placeholder="7131052142">
                    </div>
                </div>
                
                <div class="space-y-4">
                    <h3 class="text-lg font-semibold text-gray-300">äº¤æ˜“å‚æ•°</h3>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm text-gray-400 mb-1">è´¦æˆ·ä½™é¢ ($)</label>
                            <input type="number" id="accountBalance" value="100"
                                   class="w-full px-3 py-2 bg-gray-900 border border-gray-700 rounded-lg text-gray-100">
                        </div>
                        <div>
                            <label class="block text-sm text-gray-400 mb-1">å•ç¬”é£é™© (%)</label>
                            <input type="number" id="riskPerTrade" value="2" step="0.1"
                                   class="w-full px-3 py-2 bg-gray-900 border border-gray-700 rounded-lg text-gray-100">
                        </div>
                        <div>
                            <label class="block text-sm text-gray-400 mb-1">æœ€å¤§ä»“ä½ (%)</label>
                            <input type="number" id="maxPosition" value="50" step="1"
                                   class="w-full px-3 py-2 bg-gray-900 border border-gray-700 rounded-lg text-gray-100">
                        </div>
                        <div>
                            <label class="block text-sm text-gray-400 mb-1">å†·å´æ—¶é—´ (ç§’)</label>
                            <input type="number" id="cooldownTime" value="180" step="10"
                                   class="w-full px-3 py-2 bg-gray-900 border border-gray-700 rounded-lg text-gray-100">
                        </div>
                    </div>
                </div>
            </div>
            <div class="mt-6 flex justify-end space-x-3">
                <button onclick="saveConfig()" class="px-4 py-2 bg-green-600 hover:bg-green-700 rounded-lg font-semibold">
                    <i class="fas fa-save mr-2"></i>ä¿å­˜é…ç½®
                </button>
                <button onclick="closeConfigPanel()" class="px-4 py-2 bg-gray-600 hover:bg-gray-700 rounded-lg font-semibold">
                    å–æ¶ˆ
                </button>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
            <!-- å®æ—¶ä»·æ ¼ -->
            <div class="bg-gray-800 rounded-xl p-6 shadow-lg border border-gray-700">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-semibold">
                        <i class="fas fa-chart-line text-blue-400 mr-2"></i>å®æ—¶å¸‚åœº
                    </h2>
                    <span id="marketStatus" class="px-3 py-1 text-xs rounded-full bg-green-900 text-green-300">
                        <i class="fas fa-circle animate-pulse mr-1"></i>è¿æ¥æ­£å¸¸
                    </span>
                </div>
                <div class="text-center py-4">
                    <div id="priceDisplay" class="text-5xl font-bold text-green-400 mb-2">$--</div>
                    <div class="text-gray-400 mb-1">BTC/USDT</div>
                    <div id="updateTime" class="text-sm text-gray-500">--:--:--</div>
                </div>
                <div class="mt-4 pt-4 border-t border-gray-700">
                    <div class="flex justify-between text-sm">
                        <span class="text-gray-400">24hæœ€é«˜:</span>
                        <span id="high24h" class="text-green-400">$--</span>
                    </div>
                    <div class="flex justify-between text-sm mt-1">
                        <span class="text-gray-400">24hæœ€ä½:</span>
                        <span id="low24h" class="text-red-400">$--</span>
                    </div>
                    <div class="flex justify-between text-sm mt-1">
                        <span class="text-gray-400">24hæ¶¨å¹…:</span>
                        <span id="change24h" class="text-gray-300">--%</span>
                    </div>
                </div>
            </div>

            <!-- AIä¿¡å· -->
            <div id="signalCard" class="signal-hold rounded-xl p-6 shadow-lg">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-semibold">
                        <i class="fas fa-robot text-purple-400 mr-2"></i>äº¤æ˜“ä¿¡å·
                    </h2>
                    <div id="signalStatus" class="px-3 py-1 text-xs rounded-full bg-purple-900 text-purple-300">
                        <i class="fas fa-cog fa-spin mr-1"></i>ç­‰å¾…ä¸­...
                    </div>
                </div>
                
                <div id="tradeStatus" class="mb-4 p-3 bg-gray-900/50 rounded-lg border border-gray-700">
                    <div class="flex justify-between items-center">
                        <span class="text-gray-400">çŠ¶æ€:</span>
                        <span id="statusText" class="text-yellow-400">æ— æ´»è·ƒäº¤æ˜“</span>
                    </div>
                    <div class="mt-2 text-sm text-gray-300" id="statusDetails">
                        ç­‰å¾…äº¤æ˜“æœºä¼š...
                    </div>
                </div>
                
                <div class="text-center py-2">
                    <div id="signalAction" class="text-4xl font-bold mb-2">â¸ï¸ HOLD</div>
                    <div class="text-sm text-gray-300 mb-1">
                        ä¿¡å·ID: <span id="signalId" class="text-gray-400">--</span>
                    </div>
                    <div id="signalTime" class="text-sm text-gray-500">--:--:--</div>
                </div>
            </div>

            <!-- TP/SLè¿½è¸ª -->
            <div class="bg-gray-800 rounded-xl p-6 shadow-lg border border-gray-700">
                <h2 class="text-xl font-semibold mb-6">
                    <i class="fas fa-bullseye text-red-400 mr-2"></i>TP/SLè¿½è¸ª
                </h2>
                
                <div class="space-y-5">
                    <div class="grid grid-cols-3 gap-4">
                        <div class="p-3 bg-gray-900 rounded-lg text-center">
                            <div class="text-gray-400 text-sm">å…¥åœºä»·</div>
                            <div id="entryPrice" class="text-xl font-bold text-white">$--</div>
                        </div>
                        <div class="p-3 bg-green-900/30 rounded-lg border border-green-800 text-center">
                            <div class="text-green-400 text-sm">æ­¢ç›ˆä»·</div>
                            <div id="takeProfit" class="text-xl font-bold">$--</div>
                            <div class="text-xs text-gray-400 mt-1" id="tpDistance">--%</div>
                        </div>
                        <div class="p-3 bg-red-900/30 rounded-lg border border-red-800 text-center">
                            <div class="text-red-400 text-sm">æ­¢æŸä»·</div>
                            <div id="stopLoss" class="text-xl font-bold">$--</div>
                            <div class="text-xs text-gray-400 mt-1" id="slDistance">--%</div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-3 gap-3">
                        <div class="text-center p-2 bg-blue-900/20 rounded">
                            <div class="text-blue-300 text-xs">é£é™©/å›æŠ¥</div>
                            <div id="riskReward" class="font-bold">--</div>
                        </div>
                        <div class="text-center p-2 bg-yellow-900/20 rounded">
                            <div class="text-yellow-300 text-xs">ç›ˆäºæ¯”</div>
                            <div id="profitLossRatio" class="font-bold">--%</div>
                        </div>
                        <div class="text-center p-2 bg-purple-900/20 rounded">
                            <div class="text-purple-300 text-xs">æŒç»­æ—¶é—´</div>
                            <div id="tradeDuration" class="font-bold">--</div>
                        </div>
                    </div>
                    
                    <div class="mt-4" id="tpSlStatus">
                        <div class="text-sm text-gray-400">TP/SLçŠ¶æ€:</div>
                        <div class="mt-2 p-3 rounded-lg bg-gray-900/50" id="tpSlResult">
                            æœªè§¦å‘
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- äº¤æ˜“å†å² -->
        <div class="bg-gray-800 rounded-xl p-6 shadow-lg border border-gray-700 mb-8">
            <h2 class="text-xl font-semibold mb-6">
                <i class="fas fa-history text-cyan-400 mr-2"></i>äº¤æ˜“å†å²
            </h2>
            <div class="overflow-x-auto">
                <table class="w-full text-sm">
                    <thead class="bg-gray-900">
                        <tr>
                            <th class="p-3 text-left">æ—¶é—´</th>
                            <th class="p-3 text-left">ä¿¡å·</th>
                            <th class="p-3 text-left">å…¥åœºä»·</th>
                            <th class="p-3 text-left">TP</th>
                            <th class="p-3 text-left">SL</th>
                            <th class="p-3 text-left">ç»“æœ</th>
                            <th class="p-3 text-left">ç›ˆäº</th>
                            <th class="p-3 text-left">æŒç»­æ—¶é—´</th>
                            <th class="p-3 text-left">é€šçŸ¥</th>
                        </tr>
                    </thead>
                    <tbody id="tradeHistory" class="text-gray-300">
                        <tr><td colspan="9" class="p-4 text-center text-gray-500">æš‚æ— äº¤æ˜“å†å²</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // æ™ºèƒ½äº¤æ˜“ç³»ç»Ÿ
        class SmartTradingSystem {
            constructor() {
                this.API_BASE = 'https://www.okx.com/api/v5';
                this.currentSymbol = 'BTC-USDT';
                this.currentPrice = 0;
                
                // åŠ è½½é…ç½®
                this.loadConfig();
                
                // ç”¨æˆ·éš”ç¦»å­˜å‚¨
                this.userId = localStorage.getItem('trading_user_id') || this.TELEGRAM_CONFIG.defaultChatId || null;
                this.userData = this.loadUserData();
                
                this.TRADE_CONFIG = {
                    accountBalance: localStorage.getItem('trade_account_balance') ? 
                        parseFloat(localStorage.getItem('trade_account_balance')) : 100,
                    riskPerTrade: localStorage.getItem('trade_risk_percent') ? 
                        parseFloat(localStorage.getItem('trade_risk_percent')) / 100 : 0.02,
                    maxPositionPercent: localStorage.getItem('trade_max_position') ? 
                        parseFloat(localStorage.getItem('trade_max_position')) / 100 : 0.5,
                    cooldownTime: localStorage.getItem('trade_cooldown') ? 
                        parseInt(localStorage.getItem('trade_cooldown')) : 180,
                    minRRRatio: 1.5
                };
                
                // ç³»ç»ŸçŠ¶æ€
                this.systemState = {
                    activeTrade: null,
                    tradeHistory: [],
                    marketData: {},
                    lastSignalTime: null,
                    isChecking: false,
                    botConnected: false
                };
                
                this.intervals = {};
                this.isRunning = false;
                
                console.log('ğŸš€ æ™ºèƒ½äº¤æ˜“ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ');
            }
            
            // åŠ è½½é…ç½®
            loadConfig() {
                this.TELEGRAM_CONFIG = {
                    botToken: localStorage.getItem('telegram_bot_token') || '7782054036:AAGmanb4SRHTP11e8RHTzs9I8bBolHiew3w',
                    defaultChatId: localStorage.getItem('telegram_default_chat_id') || '7131052142',
                    baseUrl: 'https://api.telegram.org/bot'
                };
            }
            
            // ä¿å­˜é…ç½®
            saveConfig(config) {
                if (config.botToken) {
                    this.TELEGRAM_CONFIG.botToken = config.botToken;
                    localStorage.setItem('telegram_bot_token', config.botToken);
                }
                if (config.defaultChatId) {
                    this.TELEGRAM_CONFIG.defaultChatId = config.defaultChatId;
                    localStorage.setItem('telegram_default_chat_id', config.defaultChatId);
                }
                console.log('âœ… é…ç½®å·²ä¿å­˜');
            }
            
            // ç”¨æˆ·æ•°æ®ç®¡ç†
            loadUserData() {
                if (!this.userId) return null;
                const key = `trading_data_${this.userId}`;
                const data = localStorage.getItem(key);
                return data ? JSON.parse(data) : {
                    tradeHistory: [],
                    signals: [],
                    preferences: {}
                };
            }
            
            saveUserData() {
                if (!this.userId) return;
                const key = `trading_data_${this.userId}`;
                localStorage.setItem(key, JSON.stringify(this.userData));
            }
            
            setUserId(id) {
                this.userId = id;
                localStorage.setItem('trading_user_id', id);
                this.userData = this.loadUserData();
                document.getElementById('userIdDisplay').textContent = id;
                console.log(`âœ… ç”¨æˆ·IDå·²è®¾ç½®: ${id}`);
                this.testBotConnection();
            }
            
            // æµ‹è¯•Botè¿æ¥
            async testBotConnection() {
                if (!this.TELEGRAM_CONFIG.botToken) {
                    console.error('Bot Tokenæœªè®¾ç½®');
                    return false;
                }
                
                try {
                    const url = `${this.TELEGRAM_CONFIG.baseUrl}${this.TELEGRAM_CONFIG.botToken}/getMe`;
                    const response = await fetch(url);
                    const data = await response.json();
                    
                    if (data.ok) {
                        console.log(`âœ… Botè¿æ¥æˆåŠŸ: ${data.result.username}`);
                        this.systemState.botConnected = true;
                        return true;
                    } else {
                        console.error('Botè¿æ¥å¤±è´¥:', data);
                        return false;
                    }
                } catch (error) {
                    console.error('Botè¿æ¥é”™è¯¯:', error);
                    return false;
                }
            }
            
            // æ ¸å¿ƒäº¤æ˜“é€»è¾‘
            async generateSmartSignal() {
                if (this.systemState.isChecking) {
                    console.log('ğŸ” æ­£åœ¨æ£€æŸ¥ä¸­ï¼Œè·³è¿‡æ–°ä¿¡å·');
                    return;
                }
                
                // æ£€æŸ¥Botè¿æ¥
                if (!this.systemState.botConnected) {
                    console.log('âš ï¸ Botæœªè¿æ¥ï¼Œè·³è¿‡ä¿¡å·ç”Ÿæˆ');
                    return;
                }
                
                // æ£€æŸ¥æ˜¯å¦æœ‰æ´»è·ƒäº¤æ˜“
                if (this.systemState.activeTrade) {
                    console.log('âš¡ æœ‰æ´»è·ƒäº¤æ˜“ï¼Œå…ˆæ£€æŸ¥TP/SL');
                    await this.checkTP_SL();
                    return;
                }
                
                // å†·å´æ—¶é—´æ£€æŸ¥
                if (this.systemState.lastSignalTime) {
                    const now = Date.now();
                    const timeDiff = (now - this.systemState.lastSignalTime) / 1000;
                    if (timeDiff < this.TRADE_CONFIG.cooldownTime) {
                        const remaining = Math.ceil(this.TRADE_CONFIG.cooldownTime - timeDiff);
                        console.log(`â³ å†·å´æ—¶é—´ä¸­ï¼Œè¿˜éœ€${remaining}ç§’`);
                        return;
                    }
                }
                
                this.systemState.isChecking = true;
                
                try {
                    await this.getCurrentPrice();
                    const candles = await this.getCandleData('15m', 50);
                    
                    if (!candles || candles.length < 20) {
                        console.log('æ•°æ®ä¸è¶³');
                        return;
                    }
                    
                    // åˆ†æå¸‚åœº
                    await this.analyzeMarket(candles);
                    
                    // ç”Ÿæˆä¿¡å·
                    const signal = this.analyzeSignal(candles);
                    
                    if (signal.action !== 'HOLD') {
                        const trade = this.createTrade(signal);
                        this.systemState.activeTrade = trade;
                        this.systemState.lastSignalTime = Date.now();
                        
                        // ä¿å­˜åˆ°ç”¨æˆ·æ•°æ®
                        if (this.userData) {
                            this.userData.signals.push(trade);
                            this.saveUserData();
                        }
                        
                        this.displaySignal(trade);
                        this.startTP_SLMonitoring();
                        
                        // å‘é€Telegramé€šçŸ¥
                        const notificationSent = await this.sendTelegramSignal(trade);
                        trade.notificationSent = notificationSent;
                        
                        console.log(`âœ… æ–°ä¿¡å·ç”Ÿæˆ: ${signal.action}`, trade);
                    }
                    
                } catch (error) {
                    console.error('ç”Ÿæˆä¿¡å·å¤±è´¥:', error);
                } finally {
                    this.systemState.isChecking = false;
                }
            }
            
            // æ£€æŸ¥TP/SL
            async checkTP_SL() {
                if (!this.systemState.activeTrade) return;
                
                await this.getCurrentPrice();
                const trade = this.systemState.activeTrade;
                const price = this.currentPrice;
                
                let result = null;
                let reason = '';
                
                // æ£€æŸ¥æ­¢ç›ˆ
                if (trade.action === 'BUY' && price >= parseFloat(trade.tp)) {
                    result = 'TP_HIT';
                    reason = `ä»·æ ¼è¾¾åˆ°æ­¢ç›ˆä½ $${trade.tp}`;
                } else if (trade.action === 'SELL' && price <= parseFloat(trade.tp)) {
                    result = 'TP_HIT';
                    reason = `ä»·æ ¼è¾¾åˆ°æ­¢ç›ˆä½ $${trade.tp}`;
                }
                // æ£€æŸ¥æ­¢æŸ
                else if (trade.action === 'BUY' && price <= parseFloat(trade.sl)) {
                    result = 'SL_HIT';
                    reason = `ä»·æ ¼è§¦å‘æ­¢æŸ $${trade.sl}`;
                } else if (trade.action === 'SELL' && price >= parseFloat(trade.sl)) {
                    result = 'SL_HIT';
                    reason = `ä»·æ ¼è§¦å‘æ­¢æŸ $${trade.sl}`;
                }
                // æ£€æŸ¥åè½¬ä¿¡å·
                else if (this.checkReversalSignal(trade, price)) {
                    result = 'REVERSAL';
                    reason = 'å¸‚åœºå‡ºç°åè½¬ä¿¡å·';
                }
                
                if (result) {
                    await this.closeTrade(result, reason);
                }
            }
            
            // æ£€æŸ¥åè½¬ä¿¡å·
            checkReversalSignal(trade, currentPrice) {
                const priceChange = ((currentPrice - parseFloat(trade.price)) / parseFloat(trade.price)) * 100;
                
                if (trade.action === 'BUY' && priceChange < -2) {
                    return true;
                } else if (trade.action === 'SELL' && priceChange > 2) {
                    return true;
                }
                
                return false;
            }
            
            // åˆ›å»ºäº¤æ˜“
            createTrade(signal) {
                const price = this.currentPrice;
                const { tp, sl } = this.calculateTP_SL(signal.action, price);
                const positionSize = this.calculatePositionSize(price, sl);
                const risk = Math.abs(price - sl);
                const reward = Math.abs(tp - price);
                const rrRatio = (reward / risk).toFixed(2);
                
                return {
                    id: `trade_${Date.now()}_${this.userId || 'anon'}`,
                    userId: this.userId,
                    action: signal.action,
                    price: price.toFixed(2),
                    tp: tp.toFixed(2),
                    sl: sl.toFixed(2),
                    positionSize: positionSize.toFixed(2),
                    riskReward: rrRatio,
                    reason: signal.reason,
                    confidence: signal.confidence,
                    timestamp: new Date().toISOString(),
                    status: 'active',
                    startTime: Date.now(),
                    notificationSent: false
                };
            }
            
            // è®¡ç®—TP/SL
            calculateTP_SL(action, entryPrice) {
                const atr = this.systemState.marketData.atr || 100;
                const volatility = this.systemState.marketData.volatility || 2;
                
                let tp, sl;
                
                if (action === 'BUY') {
                    const tp1 = entryPrice + (atr * 2);
                    const tp2 = entryPrice * 1.03;
                    tp = Math.max(tp1, tp2);
                    
                    const sl1 = entryPrice - (atr * 1);
                    const sl2 = entryPrice * 0.985;
                    sl = Math.min(sl1, sl2);
                } else {
                    const tp1 = entryPrice - (atr * 2);
                    const tp2 = entryPrice * 0.97;
                    tp = Math.min(tp1, tp2);
                    
                    const sl1 = entryPrice + (atr * 1);
                    const sl2 = entryPrice * 1.015;
                    sl = Math.max(sl1, sl2);
                }
                
                // ç¡®ä¿æœ€å°é£é™©å›æŠ¥æ¯”
                const risk = Math.abs(entryPrice - sl);
                const reward = Math.abs(tp - entryPrice);
                
                if (reward / risk < this.TRADE_CONFIG.minRRRatio) {
                    const adjustedTP = action === 'BUY' ? 
                        entryPrice + (risk * this.TRADE_CONFIG.minRRRatio) :
                        entryPrice - (risk * this.TRADE_CONFIG.minRRRatio);
                    tp = adjustedTP;
                }
                
                return { tp, sl };
            }
            
            // å…³é—­äº¤æ˜“
            async closeTrade(result, reason) {
                if (!this.systemState.activeTrade) return;
                
                const trade = this.systemState.activeTrade;
                const now = Date.now();
                const duration = Math.floor((now - trade.startTime) / 1000);
                const durationStr = duration > 60 ? 
                    `${Math.floor(duration/60)}åˆ†${duration%60}ç§’` : 
                    `${duration}ç§’`;
                
                // è®¡ç®—ç›ˆäº
                const exitPrice = this.currentPrice;
                let pnlPercent = 0;
                
                if (result === 'TP_HIT') {
                    pnlPercent = trade.action === 'BUY' ?
                        ((parseFloat(trade.tp) - parseFloat(trade.price)) / parseFloat(trade.price) * 100) :
                        ((parseFloat(trade.price) - parseFloat(trade.tp)) / parseFloat(trade.price) * 100);
                } else if (result === 'SL_HIT') {
                    pnlPercent = trade.action === 'BUY' ?
                        ((parseFloat(trade.sl) - parseFloat(trade.price)) / parseFloat(trade.price) * 100) :
                        ((parseFloat(trade.price) - parseFloat(trade.sl)) / parseFloat(trade.price) * 100);
                } else {
                    pnlPercent = trade.action === 'BUY' ?
                        ((exitPrice - parseFloat(trade.price)) / parseFloat(trade.price) * 100) :
                        ((parseFloat(trade.price) - exitPrice) / parseFloat(trade.price) * 100);
                }
                
                // æ›´æ–°äº¤æ˜“è®°å½•
                const closedTrade = {
                    ...trade,
                    status: 'closed',
                    result: result,
                    reason: reason,
                    exitPrice: exitPrice.toFixed(2),
                    pnlPercent: pnlPercent.toFixed(2),
                    duration: durationStr,
                    endTime: now,
                    notificationSent: false
                };
                
                // æ·»åŠ åˆ°å†å²
                this.systemState.tradeHistory.unshift(closedTrade);
                if (this.userData) {
                    this.userData.tradeHistory.unshift(closedTrade);
                    this.saveUserData();
                }
                
                // å‘é€Telegramé€šçŸ¥
                const notificationSent = await this.sendTelegramTradeResult(closedTrade);
                closedTrade.notificationSent = notificationSent;
                
                // æ¸…ç†æ´»è·ƒäº¤æ˜“
                this.systemState.activeTrade = null;
                
                // æ›´æ–°UI
                this.updateTradeStatus(result, reason);
                this.updateHistoryDisplay();
                
                console.log(`ğŸ“Š äº¤æ˜“å…³é—­: ${result}`, closedTrade);
                
                // é‡ç½®å†·å´æ—¶é—´
                this.systemState.lastSignalTime = now;
            }
            
            // åˆ†æä¿¡å·
            analyzeSignal(candles) {
                const price = this.currentPrice;
                const marketStructure = this.systemState.marketData.marketStructure;
                
                let action = 'HOLD';
                let reason = '';
                let confidence = 0.5;
                
                // ç®€å•çš„ä¿¡å·é€»è¾‘
                if (marketStructure === 'uptrend') {
                    const recentLow = Math.min(...candles.slice(-5).map(c => c.low));
                    if (price <= recentLow * 1.005) {
                        action = 'BUY';
                        reason = 'ä¸Šå‡è¶‹åŠ¿ä¸­çš„å›è°ƒä¹°å…¥æœºä¼š';
                        confidence = 0.65;
                    }
                } else if (marketStructure === 'downtrend') {
                    const recentHigh = Math.max(...candles.slice(-5).map(c => c.high));
                    if (price >= recentHigh * 0.995) {
                        action = 'SELL';
                        reason = 'ä¸‹é™è¶‹åŠ¿ä¸­çš„åå¼¹å–å‡ºæœºä¼š';
                        confidence = 0.65;
                    }
                } else if (marketStructure === 'consolidation') {
                    const rangeHigh = Math.max(...candles.slice(-20).map(c => c.high));
                    const rangeLow = Math.min(...candles.slice(-20).map(c => c.low));
                    const rangeMid = (rangeHigh + rangeLow) / 2;
                    
                    if (price <= rangeMid && price >= rangeLow * 1.005) {
                        action = 'BUY';
                        reason = 'ç›˜æ•´åŒºé—´ä¸‹æ²¿æ”¯æ’‘ä¹°å…¥';
                        confidence = 0.6;
                    } else if (price >= rangeMid && price <= rangeHigh * 0.995) {
                        action = 'SELL';
                        reason = 'ç›˜æ•´åŒºé—´ä¸Šæ²¿é˜»åŠ›å–å‡º';
                        confidence = 0.6;
                    }
                }
                
                return { action, reason, confidence };
            }
            
            // å¼€å§‹ç›‘æ§TP/SL
            startTP_SLMonitoring() {
                if (this.intervals.tpSlCheck) {
                    clearInterval(this.intervals.tpSlCheck);
                }
                
                this.intervals.tpSlCheck = setInterval(() => {
                    this.checkTP_SL();
                }, 5000);
            }
            
            // Telegramé€šçŸ¥
            async sendTelegramSignal(trade) {
                if (!this.TELEGRAM_CONFIG.botToken || !this.userId) return false;
                
                try {
                    const message = `
ğŸš¨ *æ–°çš„äº¤æ˜“ä¿¡å·* ğŸš¨

ğŸ“Š *äº¤æ˜“è¯¦æƒ…*
â€¢ æ–¹å‘: ${trade.action === 'BUY' ? 'ğŸ”¼ ä¹°å…¥' : 'ğŸ”½ å–å‡º'}
â€¢ å…¥åœºä»·: $${trade.price}
â€¢ æ­¢ç›ˆä»·: $${trade.tp}
â€¢ æ­¢æŸä»·: $${trade.sl}
â€¢ é£é™©å›æŠ¥æ¯”: ${trade.riskReward}:1
â€¢ ä¿¡å¿ƒæŒ‡æ•°: ${(trade.confidence * 100).toFixed(0)}%

ğŸ“ˆ *åˆ†æç†ç”±*
${trade.reason}

â° æ—¶é—´: ${new Date().toLocaleTimeString('zh-CN')}
ğŸ“ ID: ${trade.id}
                    `;
                    
                    const success = await this.sendTelegramMessage(message);
                    return success;
                } catch (error) {
                    console.error('å‘é€Telegramä¿¡å·å¤±è´¥:', error);
                    return false;
                }
            }
            
            async sendTelegramTradeResult(trade) {
                if (!this.TELEGRAM_CONFIG.botToken || !this.userId) return false;
                
                try {
                    const resultEmoji = trade.result === 'TP_HIT' ? 'âœ…' : trade.result === 'SL_HIT' ? 'âŒ' : 'âš ï¸';
                    const resultText = trade.result === 'TP_HIT' ? 'æ­¢ç›ˆè¾¾æˆ' : 
                                     trade.result === 'SL_HIT' ? 'æ­¢æŸè§¦å‘' : 'å¹³ä»“';
                    
                    const message = `
${resultEmoji} *äº¤æ˜“ç»“æŸ* ${resultEmoji}

ğŸ“Š *äº¤æ˜“ç»“æœ*
â€¢ ä¿¡å·: ${trade.action}
â€¢ å…¥åœºä»·: $${trade.price}
â€¢ å‡ºåœºä»·: $${trade.exitPrice}
â€¢ ç»“æœ: ${resultText}
â€¢ ç›ˆäº: ${trade.pnlPercent}%
â€¢ æŒç»­æ—¶é—´: ${trade.duration}

ğŸ“ *è¯¦æƒ…*
${trade.reason}

â° ç»“æŸæ—¶é—´: ${new Date().toLocaleTimeString('zh-CN')}
ğŸ“ ID: ${trade.id}
                    `;
                    
                    const success = await this.sendTelegramMessage(message);
                    return success;
                } catch (error) {
                    console.error('å‘é€Telegramç»“æœå¤±è´¥:', error);
                    return false;
                }
            }
            
            async sendTelegramMessage(text) {
                try {
                    const url = `${this.TELEGRAM_CONFIG.baseUrl}${this.TELEGRAM_CONFIG.botToken}/sendMessage`;
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            chat_id: this.userId,
                            text: text,
                            parse_mode: 'Markdown',
                            disable_web_page_preview: true
                        })
                    });
                    
                    const result = await response.json();
                    if (result.ok) {
                        console.log('âœ… Telegramé€šçŸ¥å‘é€æˆåŠŸ');
                        return true;
                    } else {
                        console.error('Telegramå‘é€å¤±è´¥:', result.description);
                        return false;
                    }
                } catch (error) {
                    console.error('Telegramå‘é€é”™è¯¯:', error);
                    return false;
                }
            }
            
            // å…¶ä»–æ–¹æ³•
            calculatePositionSize(entryPrice, sl) {
                const riskAmount = this.TRADE_CONFIG.accountBalance * this.TRADE_CONFIG.riskPerTrade;
                const riskPerUnit = Math.abs(entryPrice - sl);
                let positionSize = (riskAmount / riskPerUnit) * entryPrice;
                const maxPosition = this.TRADE_CONFIG.accountBalance * this.TRADE_CONFIG.maxPositionPercent;
                return Math.min(positionSize, maxPosition);
            }
            
            async analyzeMarket(candles) {
                const levels = this.findSupportResistance(candles);
                const atr = this.calculateATR(candles, 14);
                const volatility = this.calculateVolatility(candles);
                const structure = this.determineMarketStructure(candles);
                
                this.systemState.marketData = {
                    resistanceLevels: levels.resistance,
                    supportLevels: levels.support,
                    atr,
                    volatility,
                    marketStructure: structure
                };
            }
            
            findSupportResistance(candles) {
                const highs = candles.map(c => c.high);
                const lows = candles.map(c => c.low);
                const resistance = [], support = [];
                
                for (let i = 2; i < candles.length - 2; i++) {
                    if (highs[i] > highs[i-1] && highs[i] > highs[i-2] && 
                        highs[i] > highs[i+1] && highs[i] > highs[i+2]) {
                        resistance.push(highs[i]);
                    }
                    if (lows[i] < lows[i-1] && lows[i] < lows[i-2] && 
                        lows[i] < lows[i+1] && lows[i] < lows[i+2]) {
                        support.push(lows[i]);
                    }
                }
                
                return {
                    resistance: [...new Set(resistance)].slice(0, 3),
                    support: [...new Set(support)].slice(0, 3)
                };
            }
            
            calculateATR(candles, period) {
                if (candles.length < period) return 0;
                const trValues = [];
                
                for (let i = 1; i < candles.length; i++) {
                    const high = candles[i].high;
                    const low = candles[i].low;
                    const prevClose = candles[i-1].close;
                    const tr = Math.max(high - low, Math.abs(high - prevClose), Math.abs(low - prevClose));
                    trValues.push(tr);
                }
                
                let atr = 0;
                for (let i = 0; i < period; i++) atr += trValues[i];
                return atr / period;
            }
            
            calculateVolatility(candles) {
                if (candles.length < 10) return 0;
                const returns = [];
                for (let i = 1; i < candles.length; i++) {
                    returns.push((candles[i].close - candles[i-1].close) / candles[i-1].close);
                }
                const mean = returns.reduce((a, b) => a + b) / returns.length;
                const variance = returns.reduce((a, b) => a + Math.pow(b - mean, 2), 0) / returns.length;
                return Math.sqrt(variance) * Math.sqrt(252) * 100;
            }
            
            determineMarketStructure(candles) {
                if (candles.length < 20) return 'neutral';
                const recent = candles.slice(-20);
                const highs = recent.map(c => c.high);
                const lows = recent.map(c => c.low);
                
                let higherHighs = 0, higherLows = 0, lowerHighs = 0, lowerLows = 0;
                for (let i = 1; i < recent.length; i++) {
                    if (highs[i] > highs[i-1]) higherHighs++;
                    if (lows[i] > lows[i-1]) higherLows++;
                    if (highs[i] < highs[i-1]) lowerHighs++;
                    if (lows[i] < lows[i-1]) lowerLows++;
                }
                
                if (higherHighs > 12 && higherLows > 12) return 'uptrend';
                if (lowerHighs > 12 && lowerLows > 12) return 'downtrend';
                
                const range = Math.max(...highs) - Math.min(...lows);
                const avgPrice = recent.reduce((sum, c) => sum + c.close, 0) / recent.length;
                if (range / avgPrice < 0.02) return 'consolidation';
                
                return 'neutral';
            }
            
            async getCurrentPrice() {
                try {
                    const response = await fetch(`${this.API_BASE}/market/ticker?instId=${this.currentSymbol}`);
                    const data = await response.json();
                    if (data.code === '0' && data.data && data.data[0]) {
                        const ticker = data.data[0];
                        this.currentPrice = parseFloat(ticker.last);
                        
                        // æ›´æ–°24hæ•°æ®
                        if (ticker.high24h) {
                            document.getElementById('high24h').textContent = `$${parseFloat(ticker.high24h).toLocaleString('en-US', {
                                minimumFractionDigits: 2,
                                maximumFractionDigits: 2
                            })}`;
                        }
                        if (ticker.low24h) {
                            document.getElementById('low24h').textContent = `$${parseFloat(ticker.low24h).toLocaleString('en-US', {
                                minimumFractionDigits: 2,
                                maximumFractionDigits: 2
                            })}`;
                        }
                        if (ticker.vol24h && ticker.volCcy24h) {
                            const change = ((parseFloat(ticker.last) - parseFloat(ticker.open24h)) / parseFloat(ticker.open24h) * 100).toFixed(2);
                            document.getElementById('change24h').textContent = `${change}%`;
                            document.getElementById('change24h').className = change >= 0 ? 'text-green-400' : 'text-red-400';
                        }
                        
                        this.updatePriceDisplay();
                        return this.currentPrice;
                    }
                } catch (error) {
                    console.error('è·å–ä»·æ ¼å¤±è´¥:', error);
                }
                return null;
            }
            
            async getCandleData(interval = '15m', limit = 50) {
                try {
                    const response = await fetch(
                        `${this.API_BASE}/market/candles?instId=${this.currentSymbol}&bar=${interval}&limit=${limit}`
                    );
                    const data = await response.json();
                    if (data.code === '0' && data.data) {
                        return data.data.map(candle => ({
                            timestamp: parseInt(candle[0]),
                            open: parseFloat(candle[1]),
                            high: parseFloat(candle[2]),
                            low: parseFloat(candle[3]),
                            close: parseFloat(candle[4]),
                            volume: parseFloat(candle[5])
                        })).reverse();
                    }
                } catch (error) {
                    console.error('è·å–Kçº¿æ•°æ®å¤±è´¥:', error);
                }
                return [];
            }
            
            // UIæ›´æ–°æ–¹æ³•
            updatePriceDisplay() {
                const priceElement = document.getElementById('priceDisplay');
                const timeElement = document.getElementById('updateTime');
                
                if (priceElement && this.currentPrice) {
                    priceElement.textContent = `$${this.currentPrice.toLocaleString('en-US', {
                        minimumFractionDigits: 2,
                        maximumFractionDigits: 2
                    })}`;
                }
                
                if (timeElement) {
                    timeElement.textContent = new Date().toLocaleTimeString('zh-CN');
                }
            }
            
            displaySignal(trade) {
                const card = document.getElementById('signalCard');
                const actionElement = document.getElementById('signalAction');
                const statusElement = document.getElementById('signalStatus');
                const statusText = document.getElementById('statusText');
                const statusDetails = document.getElementById('statusDetails');
                
                if (card) {
                    card.className = 'rounded-xl p-6 shadow-lg';
                    if (trade.action === 'BUY') {
                        card.classList.add('signal-buy');
                        if (actionElement) actionElement.innerHTML = 'ğŸ”¼ BUY';
                    } else {
                        card.classList.add('signal-sell');
                        if (actionElement) actionElement.innerHTML = 'ğŸ”½ SELL';
                    }
                }
                
                if (statusElement) {
                    statusElement.className = 'px-3 py-1 text-xs rounded-full bg-green-900 text-green-300';
                    statusElement.innerHTML = '<i class="fas fa-check-circle mr-1"></i>æ´»è·ƒäº¤æ˜“';
                }
                
                if (statusText) statusText.textContent = 'äº¤æ˜“è¿›è¡Œä¸­';
                if (statusDetails) statusDetails.textContent = `ç›®æ ‡: $${trade.tp} | æ­¢æŸ: $${trade.sl}`;
                
                document.getElementById('signalId').textContent = trade.id.slice(0, 8) + '...';
                
                // æ›´æ–°äº¤æ˜“å‚æ•°æ˜¾ç¤º
                this.updateTradeDisplay(trade);
            }
            
            updateTradeDisplay(trade) {
                const entryElement = document.getElementById('entryPrice');
                const tpElement = document.getElementById('takeProfit');
                const slElement = document.getElementById('stopLoss');
                const rrElement = document.getElementById('riskReward');
                
                if (entryElement) entryElement.textContent = `$${trade.price}`;
                if (tpElement) tpElement.textContent = `$${trade.tp}`;
                if (slElement) slElement.textContent = `$${trade.sl}`;
                if (rrElement) rrElement.textContent = `${trade.riskReward}:1`;
                
                // è®¡ç®—è·ç¦»ç™¾åˆ†æ¯”
                if (this.currentPrice) {
                    const tpDistance = ((parseFloat(trade.tp) - this.currentPrice) / this.currentPrice * 100).toFixed(2);
                    const slDistance = ((this.currentPrice - parseFloat(trade.sl)) / this.currentPrice * 100).toFixed(2);
                    
                    document.getElementById('tpDistance').textContent = `${tpDistance}%`;
                    document.getElementById('slDistance').textContent = `${slDistance}%`;
                    
                    // è®¡ç®—ç›ˆäºæ¯”
                    const currentPnl = trade.action === 'BUY' ?
                        ((this.currentPrice - parseFloat(trade.price)) / parseFloat(trade.price) * 100) :
                        ((parseFloat(trade.price) - this.currentPrice) / parseFloat(trade.price) * 100);
                    document.getElementById('profitLossRatio').textContent = `${currentPnl.toFixed(2)}%`;
                    
                    // è®¡ç®—æŒç»­æ—¶é—´
                    const duration = Math.floor((Date.now() - trade.startTime) / 1000);
                    const durationStr = duration > 60 ? 
                        `${Math.floor(duration/60)}åˆ†${duration%60}ç§’` : 
                        `${duration}ç§’`;
                    document.getElementById('tradeDuration').textContent = durationStr;
                }
            }
            
            updateTradeStatus(result, reason) {
                const card = document.getElementById('signalCard');
                const actionElement = document.getElementById('signalAction');
                const statusElement = document.getElementById('signalStatus');
                const statusText = document.getElementById('statusText');
                const statusDetails = document.getElementById('statusDetails');
                const tpSlResult = document.getElementById('tpSlResult');
                
                if (card) {
                    card.className = 'rounded-xl p-6 shadow-lg signal-closed';
                    
                    if (result === 'TP_HIT') {
                        card.classList.add('tp-hit');
                        if (actionElement) actionElement.innerHTML = 'âœ… TPè¾¾æˆ';
                    } else if (result === 'SL_HIT') {
                        card.classList.add('sl-hit');
                        if (actionElement) actionElement.innerHTML = 'âŒ SLè§¦å‘';
                    } else {
                        if (actionElement) actionElement.innerHTML = 'âš ï¸ å·²å¹³ä»“';
                    }
                }
                
                if (statusElement) {
                    statusElement.className = 'px-3 py-1 text-xs rounded-full bg-yellow-900 text-yellow-300';
                    statusElement.innerHTML = '<i class="fas fa-clock mr-1"></i>ç­‰å¾…æ–°ä¿¡å·';
                }
                
                if (statusText) statusText.textContent = 'äº¤æ˜“å·²ç»“æŸ';
                if (statusDetails) statusDetails.textContent = reason;
                if (tpSlResult) {
                    tpSlResult.textContent = result === 'TP_HIT' ? 'âœ… æ­¢ç›ˆè¾¾æˆ' : 
                                           result === 'SL_HIT' ? 'âŒ æ­¢æŸè§¦å‘' : 'âš ï¸ æ‰‹åŠ¨å¹³ä»“';
                    tpSlResult.className = result === 'TP_HIT' ? 'p-2 rounded-lg bg-green-900/50 text-green-300' :
                                          result === 'SL_HIT' ? 'p-2 rounded-lg bg-red-900/50 text-red-300' :
                                          'p-2 rounded-lg bg-yellow-900/50 text-yellow-300';
                }
            }
            
            updateHistoryDisplay() {
                const historyElement = document.getElementById('tradeHistory');
                if (!historyElement) return;
                
                const history = this.systemState.tradeHistory.slice(0, 10);
                
                if (history.length === 0) {
                    historyElement.innerHTML = '<tr><td colspan="9" class="p-4 text-center text-gray-500">æš‚æ— äº¤æ˜“å†å²</td></tr>';
                    return;
                }
                
                historyElement.innerHTML = history.map(trade => {
                    const time = new Date(trade.timestamp).toLocaleTimeString('zh-CN', { 
                        hour: '2-digit', minute: '2-digit' 
                    });
                    const actionClass = trade.action === 'BUY' ? 'text-green-400' : 'text-red-400';
                    const resultClass = trade.result === 'TP_HIT' ? 'text-green-400' : 
                                      trade.result === 'SL_HIT' ? 'text-red-400' : 'text-yellow-400';
                    const resultText = trade.result === 'TP_HIT' ? 'æ­¢ç›ˆ' : 
                                     trade.result === 'SL_HIT' ? 'æ­¢æŸ' : 'å¹³ä»“';
                    const notificationIcon = trade.notificationSent ? 
                        '<i class="fas fa-check-circle text-green-400" title="é€šçŸ¥å·²å‘é€"></i>' : 
                        '<i class="fas fa-times-circle text-red-400" title="é€šçŸ¥æœªå‘é€"></i>';
                    
                    return `
                        <tr class="border-b border-gray-700 hover:bg-gray-900/50">
                            <td class="p-3">${time}</td>
                            <td class="p-3 ${actionClass} font-semibold">${trade.action}</td>
                            <td class="p-3">$${trade.price}</td>
                            <td class="p-3 text-green-400">$${trade.tp}</td>
                            <td class="p-3 text-red-400">$${trade.sl}</td>
                            <td class="p-3 ${resultClass}">${resultText}</td>
                            <td class="p-3 ${parseFloat(trade.pnlPercent) >= 0 ? 'text-green-400' : 'text-red-400'}">
                                ${trade.pnlPercent}%
                            </td>
                            <td class="p-3 text-gray-400">${trade.duration}</td>
                            <td class="p-3">${notificationIcon}</td>
                        </tr>
                    `;
                }).join('');
            }
            
            startAutoMode() {
                if (this.isRunning) return;
                this.isRunning = true;
                
                // ç«‹å³è·å–ä»·æ ¼
                this.getCurrentPrice();
                
                // æ¯10ç§’æ›´æ–°ä»·æ ¼
                this.intervals.priceUpdate = setInterval(async () => {
                    await this.getCurrentPrice();
                    if (this.systemState.activeTrade) {
                        this.updateTradeDisplay(this.systemState.activeTrade);
                    }
                }, 10000);
                
                // æ¯30ç§’æ£€æŸ¥ä¿¡å·
                this.intervals.signalCheck = setInterval(async () => {
                    await this.generateSmartSignal();
                }, 30000);
                
                console.log('ğŸš€ æ™ºèƒ½äº¤æ˜“ç³»ç»Ÿå·²å¯åŠ¨');
            }
            
            stopAutoMode() {
                this.isRunning = false;
                Object.values(this.intervals).forEach(interval => {
                    if (interval) clearInterval(interval);
                });
                console.log('ğŸ›‘ ç³»ç»Ÿå·²åœæ­¢');
            }
        }

        // å…¨å±€å˜é‡å’Œå‡½æ•°
        let smartSystem = null;

        function initSystem() {
            if (!smartSystem) {
                smartSystem = new SmartTradingSystem();
            }
            
            // æ£€æŸ¥ç”¨æˆ·ID
            const userId = localStorage.getItem('trading_user_id') || smartSystem.TELEGRAM_CONFIG.defaultChatId;
            if (userId) {
                document.getElementById('userIdDisplay').textContent = userId;
                smartSystem.setUserId(userId);
            }
            
            // åŠ è½½å†å²æ•°æ®
            if (smartSystem.userData && smartSystem.userData.tradeHistory) {
                smartSystem.systemState.tradeHistory = smartSystem.userData.tradeHistory;
                smartSystem.updateHistoryDisplay();
            }
            
            smartSystem.startAutoMode();
            showNotification('ç³»ç»Ÿå·²å¯åŠ¨ï¼', 'success');
        }

        function manualGenerateSignal() {
            if (smartSystem) {
                smartSystem.generateSmartSignal();
            } else {
                showNotification('è¯·å…ˆå¯åŠ¨ç³»ç»Ÿ', 'error');
            }
        }

        function closeCurrentTrade() {
            if (smartSystem && smartSystem.systemState.activeTrade) {
                smartSystem.closeTrade('MANUAL_CLOSE', 'æ‰‹åŠ¨å¹³ä»“');
            } else {
                showNotification('æ²¡æœ‰æ´»è·ƒäº¤æ˜“', 'warning');
            }
        }

        function setUserId() {
            const userId = prompt('è¯·è¾“å…¥æ‚¨çš„Telegramç”¨æˆ·ID:', smartSystem?.TELEGRAM_CONFIG.defaultChatId || '');
            if (userId && /^\d+$/.test(userId)) {
                if (smartSystem) {
                    smartSystem.setUserId(userId);
                } else {
                    localStorage.setItem('trading_user_id', userId);
                    document.getElementById('userIdDisplay').textContent = userId;
                }
                showNotification(`ç”¨æˆ·IDå·²è®¾ç½®ä¸º: ${userId}`, 'success');
            } else {
                showNotification('è¯·è¾“å…¥æœ‰æ•ˆçš„æ•°å­—ç”¨æˆ·ID', 'error');
            }
        }

        async function testTelegram() {
            const userId = smartSystem?.userId || localStorage.getItem('trading_user_id');
            if (!userId) {
                showNotification('è¯·å…ˆè®¾ç½®ç”¨æˆ·ID', 'error');
                return;
            }
            
            if (!smartSystem) {
                showNotification('è¯·å…ˆå¯åŠ¨ç³»ç»Ÿ', 'error');
                return;
            }
            
            // æµ‹è¯•Botè¿æ¥
            const connected = await smartSystem.testBotConnection();
            if (!connected) {
                showNotification('Botè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥Token', 'error');
                return;
            }
            
            const testTrade = {
                id: 'test_trade_' + Date.now(),
                action: 'BUY',
                price: (smartSystem.currentPrice || 50000).toFixed(2),
                tp: ((smartSystem.currentPrice || 50000) * 1.02).toFixed(2),
                sl: ((smartSystem.currentPrice || 50000) * 0.98).toFixed(2),
                reason: 'âœ… æµ‹è¯•é€šçŸ¥ - ç³»ç»Ÿè¿è¡Œæ­£å¸¸',
                confidence: 0.8,
                userId: userId
            };
            
            const sent = await smartSystem.sendTelegramSignal(testTrade);
            if (sent) {
                showNotification('æµ‹è¯•é€šçŸ¥å·²å‘é€ï¼Œè¯·æ£€æŸ¥Telegram', 'success');
            } else {
                showNotification('é€šçŸ¥å‘é€å¤±è´¥ï¼Œè¯·æ£€æŸ¥é…ç½®', 'error');
            }
        }

        function openConfigPanel() {
            document.getElementById('configPanel').classList.remove('hidden');
            
            // å¡«å……å½“å‰é…ç½®
            if (smartSystem) {
                document.getElementById('botToken').value = smartSystem.TELEGRAM_CONFIG.botToken;
                document.getElementById('defaultChatId').value = smartSystem.TELEGRAM_CONFIG.defaultChatId;
                document.getElementById('accountBalance').value = smartSystem.TRADE_CONFIG.accountBalance;
                document.getElementById('riskPerTrade').value = (smartSystem.TRADE_CONFIG.riskPerTrade * 100);
                document.getElementById('maxPosition').value = (smartSystem.TRADE_CONFIG.maxPositionPercent * 100);
                document.getElementById('cooldownTime').value = smartSystem.TRADE_CONFIG.cooldownTime;
            }
        }

        function closeConfigPanel() {
            document.getElementById('configPanel').classList.add('hidden');
        }

        function saveConfig() {
            if (!smartSystem) {
                smartSystem = new SmartTradingSystem();
            }
            
            const config = {
                botToken: document.getElementById('botToken').value,
                defaultChatId: document.getElementById('defaultChatId').value
            };
            
            smartSystem.saveConfig(config);
            
            // ä¿å­˜äº¤æ˜“å‚æ•°
            const accountBalance = parseFloat(document.getElementById('accountBalance').value);
            const riskPerTrade = parseFloat(document.getElementById('riskPerTrade').value);
            const maxPosition = parseFloat(document.getElementById('maxPosition').value);
            const cooldownTime = parseInt(document.getElementById('cooldownTime').value);
            
            localStorage.setItem('trade_account_balance', accountBalance);
            localStorage.setItem('trade_risk_percent', riskPerTrade);
            localStorage.setItem('trade_max_position', maxPosition);
            localStorage.setItem('trade_cooldown', cooldownTime);
            
            // æ›´æ–°ç³»ç»Ÿé…ç½®
            smartSystem.TRADE_CONFIG = {
                accountBalance: accountBalance,
                riskPerTrade: riskPerTrade / 100,
                maxPositionPercent: maxPosition / 100,
                cooldownTime: cooldownTime,
                minRRRatio: 1.5
            };
            
            closeConfigPanel();
            showNotification('é…ç½®å·²ä¿å­˜', 'success');
        }

        function showNotification(message, type = 'info') {
            // åˆ›å»ºé€šçŸ¥å…ƒç´ 
            const notification = document.createElement('div');
            const colors = {
                success: 'bg-green-600',
                error: 'bg-red-600',
                warning: 'bg-yellow-600',
                info: 'bg-blue-600'
            };
            
            notification.className = `fixed top-4 right-4 ${colors[type]} text-white px-4 py-3 rounded-lg shadow-lg z-50 transform transition-transform duration-300`;
            notification.innerHTML = `
                <div class="flex items-center">
                    <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : type === 'warning' ? 'fa-exclamation-triangle' : 'fa-info-circle'} mr-2"></i>
                    <span>${message}</span>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // 3ç§’åç§»é™¤
            setTimeout(() => {
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // é¡µé¢åŠ è½½
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸ“ˆ BTC/USDT æ™ºèƒ½äº¤æ˜“ç³»ç»ŸåŠ è½½ä¸­...');
            
            // æ£€æŸ¥æœ¬åœ°å­˜å‚¨
            const userId = localStorage.getItem('trading_user_id');
            const defaultChatId = localStorage.getItem('telegram_default_chat_id') || '7131052142';
            
            if (userId) {
                document.getElementById('userIdDisplay').textContent = userId;
            } else if (defaultChatId) {
                document.getElementById('userIdDisplay').textContent = defaultChatId + ' (é»˜è®¤)';
            }
            
            // æ›´æ–°æ—¶é—´æ˜¾ç¤º
            function updateTime() {
                const now = new Date();
                const timeString = now.toLocaleTimeString('zh-CN', {
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
                document.getElementById('signalTime').textContent = timeString;
            }
            
            setInterval(updateTime, 1000);
            updateTime();
            
            console.log('âœ… ç³»ç»ŸåŠ è½½å®Œæˆ');
        });
    </script>
</body>
</html>